name: Build and Release with AndResGuard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        cache: 'gradle'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Verify Java version
      run: java -version

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew

    - name: Build APK
      run: ./gradlew assembleRelease --no-daemon

    - name: Verify APK exists
      run: find app/build/outputs -name "*.apk" | head -5

    - name: Download AndResGuard
      run: |
        wget -q https://github.com/shwenzhang/AndResGuard/releases/download/1.2.21/AndResGuard-cli-1.2.21.jar -O AndResGuard.jar

    - name: Create AndResGuard configuration
      run: |
        cat > config.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <resproguard>
            <keepmapping value="mapping.txt"/>
            <keepresource type="drawable" name="ic_launcher*"/>
            <keepresource type="mipmap" name="ic_launcher*"/>
            <keepresource type="layout" name="activity_main*"/>
            <keepresource type="string" name="app_name"/>
            <keepresource type="color" name="colorPrimary"/>
            <keepresource type="xml" name="network_security_config"/>
        </resproguard>
        EOF

    - name: Run AndResGuard
      run: |
        java -jar AndResGuard.jar \
          app/build/outputs/apk/release/app-release.apk \
          -config config.xml \
          -out app/build/outputs/apk/release/obfuscated

    - name: Verify obfuscated APK
      run: ls -la app/build/outputs/apk/release/obfuscated/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          app/build/outputs/apk/release/obfuscated/app-release_obfuscated.apk
        body: |
          ## Release Notes
          - APK processed with AndResGuard for resource obfuscation
          - Built with JDK 11
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}