name: Build and Release with AndResGuard

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew

    - name: Build APK
      run: ./gradlew assembleRelease

   # - name: Download AndResGuard
     # run: |
     #   wget https://github.com/shwenzhang/AndResGuard/releases/download/1.2.21/AndResGuard-cli-1.2.21.jar -O AndResGuard.jar

    - name: Create AndResGuard configuration
      run: |
        cat > config.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <resproguard>
            <keepmapping value="mapping.txt"/>
            <keepresource type="drawable" name="ic_launcher*"/>
            <keepresource type="mipmap" name="ic_launcher*"/>
            <keepresource type="layout" name="activity_main*"/>
            <keepresource type="string" name="app_name"/>
            <keepresource type="color" name="colorPrimary"/>
        </resproguard>
        EOF

    - name: Run AndResGuard
      run: |
        java -jar AndResGuard.jar \
          app/build/outputs/apk/release/app-release.apk \
          -config config.xml \
          -out app/build/outputs/apk/release/obfuscated

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          app/build/outputs/apk/release/obfuscated/app-release_obfuscated.apk
        body: |
          ## Release Notes
          - APK processed with AndResGuard for resource obfuscation
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}